# GeoCraft

DIYホビーCAMシステム 要求仕様書
1. 概要
本仕様書は、ホビー用途のCNCフライス盤向けに、自作（DIY）のCAMシステムを開発する際の技術的要件を定義するものである。
開発の主目的は、CAMのツールパスアルゴリズム、計算幾何学、NCコード生成ロジックの開発と学習とする。
システムは、まず最低限の2.5D加工機能の実装を目指し、将来的な3D機能への拡張性を考慮した設計とする。開発全体を通して、生成されるNCコードの安全性と信頼性の確保を最優先事項とする。

2. 開発言語の選定
システムの要件である高速な計算処理能力と、豊富なジオメトリ処理ライブラリの活用を考慮し、以下のいずれかの言語を選定することを推奨する。

| 開発言語 | 選定理由 | 推奨ライブラリ例 |
| :--- | :--- | :--- |
| Python | 豊富な科学技術計算ライブラリ、迅速なプロトタイピングが可能、可読性が高い。 | Shapely (幾何学操作), NumPy (数値計算), PyQt/Tkinter (UI) |
| C++ | 実行速度が非常に高速、メモリ管理が厳密で大規模なデータ処理に適している。 | OpenCASCADE (ジオメトリカーネル), CGAL (計算幾何学), Qt (UI) |

3. 開発環境と技術スタック
VSCodeでの開発、モダンなUI、3Dプリンタのスライサーのようなプレビュー画面という要件を満たすため、UI部分をWeb技術で構築し、計算処理を行うコア部分と連携させるハイブリッド構成を採用します。

| カテゴリ | 技術 | 役割と選定理由 |
| :--- | :--- | :--- |
| **IDE** | **Visual Studio Code** | 拡張機能が豊富で、本プロジェクトで採用するすべての技術に対応できるため。 |
| **アプリケーション<br>フレームワーク** | **Electron** | Web技術（HTML, CSS, JavaScript）でデスクトップアプリを構築するためのフレームワークです。VSCode自体もElectronで作られており、モダンなUIを実現するのに最適です。 |
| **UIライブラリ** | **React + TypeScript** | モダンなUIを効率的に構築するためのデファクトスタンダードです。コンポーネント指向で、スライサーのような複雑な画面も整理して開発できます。TypeScriptで型安全性を確保します。 |
| **3Dビューア** | **Three.js** | Webブラウザ上で3Dグラフィックスを扱うための最も人気のあるライブラリです。STLなどの3Dモデルを読み込み、マウスで操作する「スライサーチックな画面」のコア部分を担います。 |
| **計算エンジン<br>(バックエンド)** | **Python** | 本仕様書の通り、ツールパス計算などの重い処理を担当します。豊富な科学計算ライブラリ（Numpy, Shapelyなど）を活用できます。 |

#### この構成のメリット
*   **モダンなUI:** ReactとCSSフレームワーク（例: Tailwind CSS）を組み合わせることで、洗練されたデザインのUIを迅速に構築できます。
*   **強力な3D表現:** Three.jsは非常に高機能で、モデルの表示、ツールパスの可視化、切削シミュレーションなど、スライサーに必要な3D表現を柔軟に実現できます。
*   **関心の分離:** UI（Electron/React）と計算ロジック（Python）が明確に分離されるため、それぞれの開発に集中でき、メンテナンス性が向上します。
*   **開発効率:** Web技術はUI開発のサイクルが速く、ホットリロードなどの機能でプレビューしながら効率的に開発を進められます。

#### 開発の進め方イメージ
1.  **Electron**でアプリケーションの土台を作る。
2.  **React**でUIコンポーネント（ボタン、設定パネルなど）を構築する。
3.  **Three.js**を使って、3Dモデルを表示・操作するビューア領域をReactコンポーネントとして作成する。
4.  UIからの操作（例: 「ツールパス生成」ボタンのクリック）をトリガーに、Electronの機能を使って**Python**の計算処理スクリプトを呼び出す。
5.  Pythonが生成したツールパスのデータをReactに渡し、**Three.js**で3Dビューア上に描画する。

4. システムアーキテクチャ
メンテナンス性と拡張性を確保するため、システムは以下の独立したモジュールで構成される疎結合なアーキテクチャを採用する。

[CADファイル入力] -> [ジオメトリ処理エンジン] -> [ツールパス生成コア] -> [NCコード出力 (ポストプロセッサ)] -> [CNC制御モジュール]
      ^                      |                            |                           |                      |
      |                      +------------+---------------+---------------------------+----------------------+
      |                                   |
      +----------------------------> [UI / シミュレーション]

CAD入力モジュール: DXF, SVG, STL等のファイルを解釈し、内部データ構造に変換する。

ジオメトリ処理エンジン: オフセット計算やブール演算など、ツールパス生成に必要な幾何学的演算を行う。

ツールパス生成コア: 加工戦略に基づき、工具の移動経路（ツールパス）を計算する。

NCコード出力モジュール (ポストプロセッサ): 生成されたツールパスを、対象のCNC制御装置が解釈可能なGコード/Mコードに変換する。

UI / シミュレーション: ユーザーがファイルを読み込み、設定を行い、生成されたツールパスを視覚的に確認するためのインターフェース。安全性担保の要となる。

CNC制御モジュール: 生成されたNCコードをホビー用CNCマシンに送信し、加工を制御する。

5. 機能要求仕様
開発は段階的に行い、まずは「最小要件」である2.5D加工の実現を目指す。

| カテゴリ | 最小要件（2.5Dの実現） | 拡張要件（3Dへのステップ） |
| :--- | :--- | :--- |
| 入力対応形式 | DXF (2Dベクトル), SVG (スケーラブル) | STL, OBJ (3Dメッシュデータ) |
| ジオメトリ処理 | ・オフセット演算 (工具半径補正)<br>・ブール演算 (ポケット/島残し加工用) | ・STLメッシュ修復<br>・ノーマルベクトル計算<br>・ソリッドモデルへの変換 |
| ツールパス戦略 | ・輪郭加工 (内外)<br>・ポケット加工 (往復/らせん)<br>・ドリル加工 (ペックサイクル) | ・Zレベルラスタリング<br>・等高線加工 (スキャロップ高制御)<br>・荒加工戦略 (工具負荷均一化) |
| 工具管理 | ・工具基本情報（直径, 長さ）の定義<br>・回転速度(RPM), 送り速度(F)の定義 | ・工具ライブラリの保存と管理<br>・工具長補正 (G43/G49) のサポート |
| NCコード生成 | ・柔軟なポストプロセッサ設定<br>・基本Gコード(G01, G02, G03)出力<br>・基本Mコード(M03/M05)出力 | ・G0 (早送り) の正確な実装と制御<br>・半径補正 (G41/G42) のサポート<br>・サブプログラム呼び出し (M98) |
| ユーザーインターフェース | ・ジオメトリの読み込みと2D表示<br>・生成されたツールパスの視覚的確認（ライン描画） | ・リアルタイム3D切削シミュレーション (残削材表示)<br>・工具と素材の衝突検出と警告 |

6. 非機能要求仕様
| 項目 | 要求内容 |
| :--- | :--- |
| 安全性 | ・最重要要件。 生成されたNCコードが工具や機械に物理的な損害を与えないこと。<br>・あらゆる加工条件下での衝突回避ロジックを実装し、徹底的にテストすること。<br>・ツールパスシミュレーション機能は、コードの安全性をユーザーが視覚的に検証するために必須とする。 |
| 信頼性 | ・アルゴリズムは数学的に検証され、意図しない動作（暴走など）を引き起こさないこと。<br>・長時間安定して動作すること。 |
| 保守性 | ・アーキテクチャの各モジュールは独立して開発・テストが可能であること。<br>・コードには適切なコメントとドキュメントを付与すること。 |
| UI/UX | ・ユーザーが直感的に操作できるシンプルなインターフェースであること。<br>・シミュレーション結果が明確で、問題箇所を特定しやすいこと。 |

7. 開発スコープと段階的アプローチ
本プロジェクトは、機能実装と並行して、品質保証と安全性検証に多大な工数を要することを前提とする。

フェーズ1: 2.5D最小要件の実装

まずは上記「機能要求仕様」の最小要件を完全に満たすことに集中する。

特に、DXFファイルの読み込み、輪郭加工とポケット加工のツールパス生成、およびその視覚的シミュレーション機能の開発を優先する。

フェーズ2: 3D拡張要件への着手

フェーズ1の機能が安定し、安全性検証のプロセスが確立された後に、拡張要件の開発を検討する。

3D機能は計算幾何学の知識を高度に要求するため、慎重な技術選定とアルゴリズム設計が不可欠となる。

フェーズ3: CNC制御機能の実装

CAM機能が安定した後、CNCマシンを直接制御する機能の開発に着手する。

8. 免責事項
本仕様書に基づき開発されたソフトウェアが生成するNCコードは、物理的な機械で実行する前に、必ず厳格なシミュレーションと検証プロセスを経る必要がある。開発されたソフトウェアの運用は自己責任の下で行うものとし、いかなる損害についても責任を負わない。

9. CNC制御機能

#### 9.1 目的
本ソフトウェアで生成したNCコードを、Grblファームウェアを搭載したホビー用CNCマシンに直接送信し、加工を実行する機能を提供する。

#### 9.2 アーキテクチャ
Electronのメインプロセスが `node-serialport` ライブラリを利用して、USB経由のシリアル通信を管理する。UIからの要求に応じて、メインプロセスがマシンとの間でコマンドの送受信を行う。

#### 9.3 機能要求
| カテゴリ | 要求内容 |
| :--- | :--- |
| **接続管理** | ・利用可能なシリアルポート（COMポート）の自動検出と一覧表示。<br>・ボーレート（Baud Rate）の選択機能（Grblの標準である115200をデフォルトとする）。<br>・マシンへの接続・切断機能。 |
| **Gコード送信** | ・Gコードの送信開始、一時停止、停止（リセット）制御。<br>・Grblの応答（`ok`）を監視し、バッファを溢れさせないようにコマンドを1行ずつ送信するストリーミング方式を採用する。<br>・送信中のGコードの行番号や、全体の進捗状況を表示する。 |
| **手動操作 (Jog)** | ・X, Y, Z軸の各方向（+, -）への手動移動。<br>・移動量（例: 0.1mm, 1mm, 10mm）の選択機能。<br>・現在の工具位置をワーク座標系の原点として設定する機能（例: `G10 L20 P1 X0 Y0 Z0`）。 |
| **状態表示とコンソール** | ・マシンの状態（例: Idle, Run, Alarm）をリアルタイムで表示する。<br>・マシンとの間で送受信されるすべてのコマンドと応答をリアルタイムで表示するコンソール機能。 |